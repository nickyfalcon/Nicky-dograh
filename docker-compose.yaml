version: '3.8'
services:
  postgres:
    image: 'postgres:15-alpine'
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: dograh
    volumes:
      - 'dograh_data_nuclear:/var/lib/postgresql/data'

  redis:
    image: 'redis:7-alpine'
    restart: always
    command: 'redis-server --requirepass ${REDIS_PASSWORD:-redissecret}'
    volumes:
      - 'dograh_redis_nuclear:/data'

  minio:
    image: minio/minio
    restart: always
    command: 'server /data --console-address ":9001"'
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: '${MINIO_ROOT_PASSWORD}'
    volumes:
      - 'dograh_minio_nuclear:/data'

  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
    restart: always
    depends_on:
      - postgres
      - redis
      - minio
    environment:
      ENVIRONMENT: production
      DATABASE_URL: 'postgres://postgres:${POSTGRES_PASSWORD}@postgres:5432/dograh'
      REDIS_URL: 'redis://:${REDIS_PASSWORD:-redissecret}@redis:6379'
      JWT_SECRET: '${JWT_SECRET}'
      MINIO_ENDPOINT: 'minio:9000'
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: '${MINIO_ROOT_PASSWORD}'
      MINIO_BUCKET: voice-audio
      MINIO_SECURE: 'false'
      ENABLE_TELEMETRY: 'false'
    expose:
      - '8000'

  ui:
    build:
      context: .
      dockerfile: ./apps/ui/Dockerfile
    restart: always
    depends_on:
      - api
    environment:
      NEXT_PUBLIC_API_URL: 'https://api.taskerflow.ir'
      NODE_ENV: production
    ports:
      - '3010:3010'

volumes:
  dograh_data_nuclear: null
  dograh_redis_nuclear: null
  dograh_minio_nuclear: null
